<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频生命周期跟踪表</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase配置 - 用户需要替换为自己的配置
        const firebaseConfig = {
         apiKey: "AIzaSyDXkOJ-bBMyROThD0al3TNpPYoSWwUvLjc",
         authDomain: "video-manager-aa6bf.firebaseapp.com",
         databaseURL: "https://video-manager-aa6bf-default-rtdb.asia-southeast1.firebasedatabase.app",
         projectId: "video-manager-aa6bf",
         storageBucket: "video-manager-aa6bf.firebasestorage.app",
         messagingSenderId: "515806508959",
         appId: "1:515806508959:web:f7e23d5f324c48b5156faa"
            };

        
        // 初始化Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // 将Firebase功能暴露到全局
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            onValue,
            push,
            remove
        };
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            window.initializeApp();
        });
    </script>
    
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .sync-status {
            background-color: #27ae60;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
            display: inline-block;
        }
        
        .sync-status.syncing {
            background-color: #f39c12;
        }
        
        .sync-status.error {
            background-color: #e74c3c;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            background-color: #f8f9fa;
        }
        
        .tab:hover {
            background-color: #f8f9fa;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .charts-container {
            padding: 20px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-item {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            height: auto;
            min-height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-item h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
            flex-shrink: 0;
        }
        
        .chart-item canvas {
            flex: 1;
            height: 450px !important;
            max-height: none;
        }
        
        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .project-stats-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .project-metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .project-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .project-metric-card h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 500;
            opacity: 0.95;
        }
        
        .project-metric-card .value {
            font-size: 32px;
            font-weight: bold;
            margin: 0;
        }
        
        .project-metric-card.not-started {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .project-metric-card.in-progress {
            background: linear-gradient(135deg, #4834d4 0%, #686de0 100%);
        }
        
        .project-metric-card.published {
            background: linear-gradient(135deg, #00d2d3 0%, #54a0ff 100%);
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-card h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .metric-card .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
            text-align: left;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }
        
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #e8f4f8;
        }
        
        .video-name {
            text-align: left;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
        }
        
        .editable {
            cursor: pointer;
            position: relative;
        }
        
        .editable:hover {
            background-color: #fff3cd;
        }
        
        .editable.editing {
            background-color: #d4edda;
        }
        
        .progress-complete {
            background-color: #27ae60;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
        }
        
        .progress-incomplete {
            background-color: #e74c3c;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
        }
        
        .metrics {
            font-weight: bold;
            color: #2980b9;
        }
        
        .total-row {
            background-color: #3498db !important;
            color: white;
            font-weight: bold;
        }
        
        .total-row td {
            background-color: #3498db;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background-color: #fdf2f2;
            border: 1px solid #fecaca;
            border-radius: 4px;
            margin: 20px;
        }
        
        .save-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: none;
        }
        
        .save-btn.show {
            display: block;
        }
        
        .action-buttons {
            margin-bottom: 10px;
            text-align: left !important;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-start !important;
            align-items: center;
        }

        .action-buttons button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-buttons button:hover {
            background-color: #2980b9;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }

            .metrics-overview {
                grid-template-columns: 1fr;
            }
            
            .project-stats-overview {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .project-metric-card {
                padding: 20px 15px;
            }
            
            .project-metric-card h4 {
                font-size: 14px;
            }
            
            .project-metric-card .value {
                font-size: 28px;
            }

            .tab {
                font-size: 14px;
                padding: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 6px;
            }
            
            .save-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .action-buttons {
                text-align: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>视频生命周期跟踪表</h1>
            <div class="sync-status" id="sync-status">🔄 连接中...</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('charts')">数据图表</div>
            <div class="tab" onclick="switchTab('table')">数据表格</div>
        </div>
        
        <!-- 图表页面 -->
        <div id="charts" class="tab-content active">
            <div class="charts-container">
                <div id="charts-loading" class="loading">正在加载图表数据...</div>
                <div id="charts-error" class="error" style="display: none;"></div>
                
                <div id="charts-content" style="display: none;">
                    <div class="metrics-overview">
                        <div class="metric-card">
                            <h4>总浏览量</h4>
                            <div class="value" id="total-views">0</div>
                        </div>
                        <div class="metric-card">
                            <h4>总点赞量</h4>
                            <div class="value" id="total-likes">0</div>
                        </div>
                        <div class="metric-card">
                            <h4>总评论量</h4>
                            <div class="value" id="total-comments">0</div>
                        </div>
                        <div class="metric-card">
                            <h4>总转发量</h4>
                            <div class="value" id="total-shares">0</div>
                        </div>
                    </div>
                    
                    <div class="project-stats-overview">
                        <div class="project-metric-card not-started">
                            <h4>未开始</h4>
                            <div class="value" id="project-not-started">0</div>
                        </div>
                        <div class="project-metric-card in-progress">
                            <h4>进行中</h4>
                            <div class="value" id="project-in-progress">0</div>
                        </div>
                        <div class="project-metric-card published">
                            <h4>已发布</h4>
                            <div class="value" id="project-published">0</div>
                        </div>
                    </div>
                    
                    <div class="chart-grid">
                        <div class="chart-item">
                            <h3>项目状态分布</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-item">
                            <h3>数据指标统计</h3>
                            <canvas id="metricsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 表格页面 -->
        <div id="table" class="tab-content">
            <div class="table-container">
                <div id="table-loading" class="loading">正在加载数据...</div>
                <div id="table-error" class="error" style="display: none;"></div>
                
                <div id="table-content" style="display: none;">
                    <div class="action-buttons">
                        <button onclick="addRow()">添加行</button>
                        <button onclick="deleteSelectedRows()">删除选中行</button>
                        <button onclick="saveData()" class="save-btn-inline" id="save-btn-inline" style="display: none;">保存更改</button>
                    </div>
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
                                <th>视频名称</th>
                                <th>剧本完成进度</th>
                                <th>剧情拍摄进度</th>
                                <th>采访拍摄进度</th>
                                <th>剪辑进度</th>
                                <th>审核进度</th>
                                <th>发布进度</th>
                                <th>浏览量</th>
                                <th>点赞量</th>
                                <th>评论量</th>
                                <th>转发量</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <button class="save-btn" id="save-btn" onclick="saveData()">保存更改</button>

    <script>
        // 初始数据
        const INITIAL_DATA = [
            {'视频名称': '智能小江全景介绍', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1200, '点赞量': 80, '评论量': 15, '转发量': 5},
            {'视频名称': '机器狗第一集-0岁小狗入职保安', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 2500, '点赞量': 150, '评论量': 30, '转发量': 10},
            {'视频名称': '调试完成！欢迎领导到访参观机器人成果', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 800, '点赞量': 50, '评论量': 10, '转发量': 3},
            {'视频名称': '宜兴支行走访', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1500, '点赞量': 100, '评论量': 20, '转发量': 8},
            {'视频名称': '端午安康', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 900, '点赞量': 60, '评论量': 12, '转发量': 4},
            {'视频名称': '机器狗第二集-技能测试全通关', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 3000, '点赞量': 200, '评论量': 40, '转发量': 15},
            {'视频名称': '高考加油视频', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1800, '点赞量': 120, '评论量': 25, '转发量': 7},
            {'视频名称': '程序员与AI结对编程的一天', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 2200, '点赞量': 180, '评论量': 35, '转发量': 12},
            {'视频名称': '一份来自人行的表扬信', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1000, '点赞量': 70, '评论量': 18, '转发量': 6},
            {'视频名称': '经开区支行走访', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1300, '点赞量': 90, '评论量': 16, '转发量': 5},
            {'视频名称': '同事间"学习强行"刷题大战', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1700, '点赞量': 110, '评论量': 22, '转发量': 9},
            {'视频名称': '夏至视频', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1100, '点赞量': 75, '评论量': 14, '转发量': 4},
            {'视频名称': '建党节视频', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1400, '点赞量': 95, '评论量': 19, '转发量': 6},
            {'视频名称': '钟楼支行走访', '剧本完成进度': '完成', '剧情拍摄进度': '完成', '采访拍摄进度': '完成', '剪辑进度': '完成', '审核进度': '完成', '发布进度': '完成', '浏览量': 1600, '点赞量': 105, '评论量': 21, '转发量': 7},
            {'视频名称': '工作日志助手', '剧本完成进度': '完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '智能会议助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '理财顾问助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '文本润色助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': 'PPT大纲助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': 'AI绘图助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '营销文案助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': 'JAVA助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '一代数字分身', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '财会知识问答助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': 'AI识图助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '直播文案助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '网络安全知识助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '维保通讯助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '对公产品问答助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '房贷知识问答助手', '剧本完成进度': '未完成', '剧情拍摄进度': '未完成', '采访拍摄进度': '未完成', '剪辑进度': '未完成', '审核进度': '未完成', '发布进度': '未完成', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '新视频 31', '剧本完成进度': '', '剧情拍摄进度': '', '采访拍摄进度': '', '剪辑进度': '', '审核进度': '', '发布进度': '', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0},
            {'视频名称': '新视频 32', '剧本完成进度': '', '剧情拍摄进度': '', '采访拍摄进度': '', '剪辑进度': '', '审核进度': '', '发布进度': '', '浏览量': 0, '点赞量': 0, '评论量': 0, '转发量': 0}
        ];

        let currentData = [];
        let hasChanges = false;
        let isConnected = false;

        // Firebase数据管理
        class FirebaseDataManager {
            constructor() {
                this.dataRef = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    if (!window.firebaseDB) {
                        throw new Error('Firebase未正确加载');
                    }

                    this.dataRef = window.firebaseDB.ref(window.firebaseDB.database, 'videoData');
                    
                    // 监听数据变化
                    window.firebaseDB.onValue(this.dataRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data && Array.isArray(data)) {
                            currentData = data;
                            this.updateUI();
                        } else if (!data) {
                            // 如果云端没有数据，上传本地数据
                            this.initializeData();
                        }
                        this.updateSyncStatus('connected');
                    }, (error) => {
                        console.error('Firebase连接错误:', error);
                        this.updateSyncStatus('error');
                        return false;
                    });

                    this.isInitialized = true;
                    return true;
                } catch (error) {
                    console.error('Firebase初始化失败:', error);
                    this.updateSyncStatus('error');
                    return false;
                }
            }

            async initializeData() {
                try {
                    await window.firebaseDB.set(this.dataRef, currentData);
                    this.updateSyncStatus('connected');
                } catch (error) {
                    console.error('初始化数据失败:', error);
                    this.updateSyncStatus('error');
                }
            }

            async saveData(data) {
                if (!this.isInitialized) {
                    this.saveToLocalStorage(data);
                    return;
                }

                try {
                    this.updateSyncStatus('syncing');
                    await window.firebaseDB.set(this.dataRef, data);
                    this.updateSyncStatus('connected');
                    hasChanges = false;
                    this.updateSaveButton();
                } catch (error) {
                    console.error('保存到Firebase失败:', error);
                    this.updateSyncStatus('error');
                    // 降级到本地存储
                    this.saveToLocalStorage(data);
                }
            }

            loadFromLocalStorage() {
                const savedData = localStorage.getItem('videoTrackingData');
                if (savedData) {
                    currentData = JSON.parse(savedData);
                } else {
                    currentData = [...INITIAL_DATA];
                    this.saveToLocalStorage(currentData);
                }
                this.updateUI();
                this.updateSyncStatus('local');
            }

            saveToLocalStorage(data) {
                localStorage.setItem('videoTrackingData', JSON.stringify(data));
                hasChanges = false;
                this.updateSaveButton();
            }

            updateSyncStatus(status) {
                const statusElement = document.getElementById('sync-status');
                switch (status) {
                    case 'connected':
                        statusElement.textContent = '✅ 已连接云端';
                        statusElement.className = 'sync-status';
                        isConnected = true;
                        break;
                    case 'syncing':
                        statusElement.textContent = '🔄 同步中...';
                        statusElement.className = 'sync-status syncing';
                        break;
                    case 'error':
                        statusElement.textContent = '❌ 连接失败，使用本地存储';
                        statusElement.className = 'sync-status error';
                        isConnected = false;
                        break;
                    case 'local':
                        statusElement.textContent = '💾 本地存储模式';
                        statusElement.className = 'sync-status error';
                        isConnected = false;
                        break;
                    default:
                        statusElement.textContent = '🔄 连接中...';
                        statusElement.className = 'sync-status syncing';
                }
            }

            updateUI() {
                // 更新当前显示的页面
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.textContent.includes('图表')) {
                    loadCharts();
                } else {
                    loadTable();
                }
            }

            updateSaveButton() {
                const saveBtn = document.getElementById('save-btn');
                const saveBtnInline = document.getElementById('save-btn-inline');
                
                if (hasChanges) {
                    saveBtn.classList.add('show');
                    saveBtnInline.style.display = 'inline-block';
                } else {
                    saveBtn.classList.remove('show');
                    saveBtnInline.style.display = 'none';
                }
            }
        }

        // 全局数据管理器实例
        const dataManager = new FirebaseDataManager();

        // 计算项目状态统计
        function calculateProjectStats(data) {
            const stats = {"未开始": 0, "进行中": 0, "已发布": 0};
            
            data.forEach(row => {
                const script = row["剧本完成进度"] || "未完成";
                const filming = row["剧情拍摄进度"] || "未完成";
                const interview = row["采访拍摄进度"] || "未完成";
                const editing = row["剪辑进度"] || "未完成";
                const review = row["审核进度"] || "未完成";
                const publish = row["发布进度"] || "未完成";
                
                if (publish === "完成") {
                    stats["已发布"]++;
                } else if ([script, filming, interview, editing, review].some(progress => progress === "完成")) {
                    stats["进行中"]++;
                } else {
                    stats["未开始"]++;
                }
            });
            
            return stats;
        }

        // 计算总数据统计
        function calculateTotalStats(data) {
            let totalViews = 0, totalLikes = 0, totalComments = 0, totalShares = 0;
            
            data.forEach(row => {
                totalViews += parseInt(row["浏览量"] || 0);
                totalLikes += parseInt(row["点赞量"] || 0);
                totalComments += parseInt(row["评论量"] || 0);
                totalShares += parseInt(row["转发量"] || 0);
            });
            
            return {
                total_views: totalViews,
                total_likes: totalLikes,
                total_comments: totalComments,
                total_shares: totalShares
            };
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab:nth-child(${tabName === 'charts' ? '1' : '2'})`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'charts') {
                loadCharts();
            } else {
                loadTable();
            }
        }

        // 加载图表
        function loadCharts() {
            const projectStats = calculateProjectStats(currentData);
            const totalStats = calculateTotalStats(currentData);
            
            // 更新数据指标
            document.getElementById('total-views').textContent = totalStats.total_views.toLocaleString();
            document.getElementById('total-likes').textContent = totalStats.total_likes.toLocaleString();
            document.getElementById('total-comments').textContent = totalStats.total_comments.toLocaleString();
            document.getElementById('total-shares').textContent = totalStats.total_shares.toLocaleString();
            
            // 更新项目状态统计
            document.getElementById('project-not-started').textContent = projectStats["未开始"];
            document.getElementById('project-in-progress').textContent = projectStats["进行中"];
            document.getElementById('project-published').textContent = projectStats["已发布"];
            
            // 显示图表内容
            document.getElementById('charts-loading').style.display = 'none';
            document.getElementById('charts-content').style.display = 'block';
            
            // 创建图表
            createCharts(projectStats, totalStats);
        }

        // 创建图表
        function createCharts(projectStats, totalStats) {
            // 清除现有图表
            const statusCanvas = document.getElementById('statusChart');
            const metricsCanvas = document.getElementById('metricsChart');
            
            if (window.statusChart) {
                window.statusChart.destroy();
            }
            if (window.metricsChart) {
                window.metricsChart.destroy();
            }

            // 项目状态饼图
            const statusCtx = statusCanvas.getContext('2d');
            window.statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['未开始', '进行中', '已发布'],
                    datasets: [{
                        data: [projectStats["未开始"], projectStats["进行中"], projectStats["已发布"]],
                        backgroundColor: ['#ff6b6b', '#4834d4', '#00d2d3']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 数据指标柱状图
            const metricsCtx = metricsCanvas.getContext('2d');
            window.metricsChart = new Chart(metricsCtx, {
                type: 'bar',
                data: {
                    labels: ['浏览量', '点赞量', '评论量', '转发量'],
                    datasets: [{
                        data: [totalStats.total_views, totalStats.total_likes, totalStats.total_comments, totalStats.total_shares],
                        backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 加载表格
        function loadTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            currentData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-select" data-index="${index}"></td>
                    <td class="video-name editable" data-field="视频名称" data-index="${index}">${row['视频名称'] || ''}</td>
                    <td class="editable" data-field="剧本完成进度" data-index="${index}">${row['剧本完成进度'] || ''}</td>
                    <td class="editable" data-field="剧情拍摄进度" data-index="${index}">${row['剧情拍摄进度'] || ''}</td>
                    <td class="editable" data-field="采访拍摄进度" data-index="${index}">${row['采访拍摄进度'] || ''}</td>
                    <td class="editable" data-field="剪辑进度" data-index="${index}">${row['剪辑进度'] || ''}</td>
                    <td class="editable" data-field="审核进度" data-index="${index}">${row['审核进度'] || ''}</td>
                    <td class="editable" data-field="发布进度" data-index="${index}">${row['发布进度'] || ''}</td>
                    <td class="editable metrics" data-field="浏览量" data-index="${index}">${row['浏览量'] || 0}</td>
                    <td class="editable metrics" data-field="点赞量" data-index="${index}">${row['点赞量'] || 0}</td>
                    <td class="editable metrics" data-field="评论量" data-index="${index}">${row['评论量'] || 0}</td>
                    <td class="editable metrics" data-field="转发量" data-index="${index}">${row['转发量'] || 0}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // 添加点击编辑事件
            document.querySelectorAll('.editable').forEach(cell => {
                cell.addEventListener('click', editCell);
            });
            
            document.getElementById('table-loading').style.display = 'none';
            document.getElementById('table-content').style.display = 'block';
        }

        // 编辑单元格
        function editCell(event) {
            const cell = event.target;
            const field = cell.dataset.field;
            const index = parseInt(cell.dataset.index);
            const currentValue = cell.textContent;
            
            if (['剧本完成进度', '剧情拍摄进度', '采访拍摄进度', '剪辑进度', '审核进度', '发布进度'].includes(field)) {
                // 进度字段使用下拉选择
                const select = document.createElement('select');
                select.innerHTML = `
                    <option value="">请选择</option>
                    <option value="未完成" ${currentValue === '未完成' ? 'selected' : ''}>未完成</option>
                    <option value="完成" ${currentValue === '完成' ? 'selected' : ''}>完成</option>
                `;
                
                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();
                
                select.addEventListener('change', () => {
                    currentData[index][field] = select.value;
                    cell.textContent = select.value;
                    markChanged();
                });
                
                select.addEventListener('blur', () => {
                    cell.textContent = select.value || currentValue;
                });
                
            } else if (['浏览量', '点赞量', '评论量', '转发量'].includes(field)) {
                // 数值字段使用数字输入
                const input = document.createElement('input');
                input.type = 'number';
                input.value = currentValue;
                input.min = '0';
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
                
                input.addEventListener('blur', () => {
                    const newValue = parseInt(input.value) || 0;
                    currentData[index][field] = newValue;
                    cell.textContent = newValue;
                    markChanged();
                });
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
                
            } else {
                // 文本字段使用文本输入
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
                
                input.addEventListener('blur', () => {
                    currentData[index][field] = input.value;
                    cell.textContent = input.value;
                    markChanged();
                });
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });
            }
        }

        // 标记数据已更改
        function markChanged() {
            hasChanges = true;
            dataManager.updateSaveButton();
        }

        // 保存数据
        function saveData() {
            dataManager.saveData(currentData);
            if (isConnected) {
                alert('数据已同步到云端！');
            } else {
                alert('数据已保存到本地存储！');
            }
        }

        // 添加行
        function addRow() {
            const newRow = {
                '视频名称': `新视频 ${currentData.length + 1}`,
                '剧本完成进度': '',
                '剧情拍摄进度': '',
                '采访拍摄进度': '',
                '剪辑进度': '',
                '审核进度': '',
                '发布进度': '',
                '浏览量': 0,
                '点赞量': 0,
                '评论量': 0,
                '转发量': 0
            };
            
            currentData.push(newRow);
            markChanged();
            loadTable();
        }

        // 删除选中行
        function deleteSelectedRows() {
            const checkboxes = document.querySelectorAll('.row-select:checked');
            const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a, b) => b - a);
            
            if (indices.length === 0) {
                alert('请先选择要删除的行');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${indices.length} 行吗？`)) {
                indices.forEach(index => {
                    currentData.splice(index, 1);
                });
                markChanged();
                loadTable();
            }
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.row-select');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
        }

        // 初始化应用
        window.initializeApp = async function() {
            // 先加载本地数据，确保界面正常显示
            dataManager.loadFromLocalStorage();
            
            // 然后尝试连接Firebase
            dataManager.updateSyncStatus('syncing');
            const firebaseSuccess = await dataManager.initialize();
            
            if (!firebaseSuccess) {
                // Firebase连接失败，使用本地数据
                dataManager.updateSyncStatus('local');
            }
            
            loadCharts();
        };
    </script>
</body>
</html>

